<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>股票数据统计</title>
    <link rel="stylesheet" href="/js/layui/css/layui.css" media="all">
</head>
<body>

<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo" style="width:auto;color: #FFB800;font-size: 18px;">Stock Space （注: 每日15点系统自动更新当日数据,
            勿频繁主动点击当日爬取,每隔3小时可主动执行）
        </div>
    </div>
</div>

<div>&nbsp;</div>

<div class="queryDataModel">
    &nbsp;&nbsp;股票代码：
    <div class="layui-inline">
        <input class="layui-input" name="stockCode" id="stockCodeDataReload" autocomplete="off">
    </div>
    &nbsp;
    &nbsp;股票名字：
    <div class="layui-inline">
        <input class="layui-input" name="stockName" id="stockNameDataReload" autocomplete="off">
    </div>
    &nbsp;
    &nbsp;股票类型：
    <div class="layui-inline">
        <select class="layui-select" name="stockMarket" id="stockMarketDataReload">
            <option value="">全部</option>
            <option value="沪深A股">沪深A股</option>
            <option value="沪市A股">沪市A股</option>
            <option value="深市A股">深市A股</option>
            <option value="创业板">创业板</option>
            <option value="中小版">中小版</option>
            <option value="沪市B股">沪市B股</option>
            <option value="深市B股">深市B股</option>
        </select>
    </div>
    &nbsp;
    &nbsp;日期选择：
    <div class="layui-inline">
        <input type="text" class="layui-input" id="dateQueryReload">
    </div>
    &nbsp;
    <button class="layui-btn" data-type="reload" style="background-color: #007DDB">搜索</button>
    &nbsp;&nbsp;&nbsp;&nbsp;
    <button class="layui-btn" style="background-color: limegreen" id="activeCrawl">爬取当日</button>
</div>

<table class="layui-hide" id="dfcf" lay-filter="dfcfFilter"></table>

<div class="layui-tab layui-tab-brief" lay-filter="dfcfFilter">
    <div class="layui-tab-content">
        <div class="layui-tab-content">
            <div class="layui-tab-item">
                <div id="pageDfcf"></div>
            </div>
        </div>
    </div>
</div>

<div id="speedChart" style="display: none;">
    <!-- 为 ECharts 准备一个具备大小（宽高）的 DOM -->
    <div id="speedChartMain" style="width: 600px; height: 400px;"></div>
</div>


<script src="/js/layui/layui.js"></script>
<script src="/js/echarts/echarts.min.js"></script>
<script src="/js/bootstrap/bootstrap.min.js"></script>
<script src="/js/jquery-3.4.1.min.js"></script>

<script th:inline="none">
    layui.use(['table', 'laypage', 'laydate', 'layer'], function () {
        var table = layui.table
            , laypage = layui.laypage
            , laydate = layui.laydate
            , layer = layui.layer
        table.render({
            elem: '#dfcf'
            , height: 920
            , id: 'dataView'
            , url: '/data/get/dfcf' //数据接口
            , where: {
                stockCode: '',
                stockName: '',
                processDate: dateToStr(new Date()),
                stockMarket: ''
            }
            , page: true //开启分页
            , limit: 20
            , limits: [20, 30, 40, 50, 60, 70, 80, 90, 100]
            , totalRow: true //开启合计行
            , cols: [
                [ //表头
                    {type: 'numbers', title: 'ID', width: 100, fixed: 'left', totalRowText: '合计：'}
                    , {field: 'processDate', title: '日期', width: 120}
                    , {field: 'stockRank', title: '排行榜名', width: 120}
                    , {field: 'stockMarket', title: '股市类型', width: 120}
                    , {field: 'stockCode', title: '股票代码', width: 120}
                    , {field: 'stockName', title: '股票名字', width: 120}
                    , {field: 'priceNew', title: '股票最新价格', width: 140, sort: true, totalRow: true}
                    , {
                    field: 'stockChange',
                    title: '涨跌幅',
                    width: 110,
                    sort: true,
                    totalRow: true,
                    templet: '#stockChangeTpl'
                }
                    , {field: 'mainNetInflowAmount', title: '主力净额', width: 140, sort: true, totalRow: true}
                    , {field: 'mainNetProportion', title: '主力净流入占比', width: 150, sort: true, totalRow: true}
                    , {field: 'superBigPartNetInflowAmount', title: '超大单净额', width: 140, sort: true, totalRow: true}
                    , {field: 'superBigPartNetProportion', title: '超大单净流入占比', width: 160, sort: true, totalRow: true}
                    // , {field: 'bigPartNetInflowAmount', title: '大单净额', width: 140, sort: true, totalRow: true}
                    // , {field: 'bigPartNetProportion', title: '大单净流入', width: 140, sort: true, totalRow: true}
                    // , {field: 'middlePartNetInflowAmount', title: '中单净额', width: 140, sort: true, totalRow: true}
                    // , {field: 'middlePartNetProportion', title: '中单净流入', width: 140, sort: true, totalRow: true}
                    // , {field: 'litterPartNetInflowAmount', title: '小单净额', width: 140, sort: true, totalRow: true}
                    // , {field: 'litterPartNetProportion', title: '小单净流入', width: 140, sort: true, totalRow: true}
                    , {field: 'createTime', title: '统计数据时间', width: 180}
                    , {fixed: 'right', width: 178, align: 'center', toolbar: '#brokenLineImg'}
                ]
            ]
        });

        //分页
        laypage.render({
            elem: 'pageDfcf' //分页容器的id
            , count: 100 //总页数
            , skip: true //开启跳页
            , jump: function (obj, first) {
                if (!first) {
                    layer.msg('第' + obj.curr + '页', {offset: 'b'});
                }
            }
        });

        //时间选择器
        laydate.render({
            elem: '#dateQueryReload',
            format: 'yyyy-MM-dd',
            value: dateToStr(new Date()),
            isInitValue: true
        });

        //指定日期格式
        function dateToStr(date) {
            var time = date;
            var y = time.getFullYear();
            var M = time.getMonth() + 1;
            M = M < 10 ? ("0" + M) : M;
            var d = time.getDate();
            d = d < 10 ? ("0" + d) : d;
            var r = y + "-" + M + "-" + d;
            console.log("=========日期:" + r);
            return r;
        }

        //搜索
        var $ = layui.$, active = {
            reload: function () {
                var stockCodeDataReload = $('#stockCodeDataReload');
                var processDateDataReload = $('#dateQueryReload');
                var stockNameDataReload = $('#stockNameDataReload');
                var stockMarketDataReload = $('#stockMarketDataReload');

                //执行重载
                table.reload('dataView', {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                    , where: {
                        stockCode: stockCodeDataReload.val(),
                        processDate: processDateDataReload.val(),
                        stockName: stockNameDataReload.val(),
                        stockMarket: stockMarketDataReload.val()
                    }
                }, 'data');
            }
        };

        $("#activeCrawl").click(function () {
            activeCrawl();
        });

        //主动爬取
        function activeCrawl() {
            layer.msg('爬取大约10分钟<br>你确定爬取？', {
                time: 2000,     //2秒自动关闭
                btn: ['确定', '取消'],
                yes: function (index) {
                    $.ajax({
                        url: "/data/active/crawl",
                        type: "Get",
                        success: function (data) {
                            console.log(data);
                            layer.msg(data.msg);
                        },
                        error: function (data) {
                            layer.msg(data.msg);
                        }
                    });
                    layer.close(index);
                }
            });
        };

        $('.queryDataModel .layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });


        $(document).ready(function () {
            option = {
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: []
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                        saveAsImage: {}
                    }
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: []
                },
                yAxis: {
                    type: 'value'
                },
                series: []
            };

            //监听工具条
            table.on('tool(dfcfFilter)', function (obj) {
                var data = obj.data;
                if (obj.event === 'detail') {  //查看详情趋势图
                    var stockCode = data.stockCode;
                    var stockMarket = data.stockMarket;
                    // 基于准备好的dom，初始化echarts实例
                    var myChart = echarts.init(document.getElementById('speedChartMain'));
                    // 使用刚指定的配置项和数据显示图表。
                    myChart.setOption(option);
                    var url = "/data/get/broken/data?stockCode=" + stockCode + "&stockMarket=" + stockMarket;
                    var times = [];  //時間数组（实际用来盛放X轴坐标值）
                    var speeds = [];  //速度数组（实际用来盛放Y坐标值）
                    $.get(url, function (data) {
                        if (data != null) {
                            datas = data.data;
                            for (var i = 0; i < datas.length; i++) {
                                times.push(datas[i].processDate);
                                speeds.push(datas[i].currentPrice);
                            }
                            //之前option中legend和 XAxis的data,series 为空，所以现在将数据填充进去
                            myChart.setOption({    //加载数据图表
                                xAxis: {
                                    data: times
                                },
                                series: [{
                                    // 根据名字对应到相应的系列
                                    name: "最新价格",
                                    type: 'line',
                                    data: speeds
                                }]
                            });
                        }

                        layer.open({
                            title: '最新价格趋势图',
                            type: 1,
                            shade: false,
                            area: ['900px', '460px'],
                            shadeClose: true, //点击遮罩关闭
                            content: $("#speedChart")
                        });
                    }, "json");
                } else if (obj.event === 'del') {        //TODO 未实现
                    layer.confirm('真的删除行么', function (index) {
                        obj.del();
                        layer.close(index);
                    });
                } else if (obj.event === 'edit') {
                    layer.alert('编辑行：<br>' + JSON.stringify(data))
                }
            });

        });

    });


</script>

<!--涨跌幅红绿标记-->
<script type="text/html" id="stockChangeTpl">
    {{#  if(d.stockChange > 0){ }}
    <span style="color: red">{{ d.stockChange }} &#8593;  </span>
    {{#  } else { }}
    <span style="color: limegreen">{{ d.stockChange }} &#8595; </span>
    {{#  } }}
</script>

<script type="text/html" id="brokenLineImg">
    <a class="layui-btn layui-btn-xs" lay-event="detail">趋势图</a>
</script>

</body>
</html>